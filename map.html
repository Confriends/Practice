<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Map with Background and Navigation</title>
  <style>
    /* ... [existing CSS] ... */
    /* Modal overlay for marker removal */
    #removeModal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.85);
      align-items: center;
      justify-content: center;
    }
    #removeModal .modal-content {
      background: #101c10;
      border: 2px solid #00FF00;
      border-radius: 10px;
      color: #00FF00;
      font-family: monospace;
      padding: 32px 36px 22px 36px;
      text-align: center;
      box-shadow: 0 0 16px #00ff1c80;
      min-width: 260px;
    }
    #removeModal button {
      background: #0c5116;
      color: #00FF00;
      border: 1.5px solid #00FF00;
      border-radius: 6px;
      font-family: monospace;
      font-size: 1em;
      padding: 5px 18px;
      margin: 0 12px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    #removeModal button:hover {
      background: #00FF00;
      color: #0c5116;
    }
  </style>
</head>
<body>
<!-- ... [existing HTML before map div] ... -->

<!-- Modal for marker removal -->
<div id="removeModal">
  <div class="modal-content">
    <div id="removeModalText" style="margin-bottom:22px;"></div>
    <button id="removeModalYes">Remove</button>
    <button id="removeModalNo">Cancel</button>
  </div>
</div>

<!-- ... [existing HTML after map div] ... -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDsz_nf-Ithx6y4mVZ3PxUR26WEMaYrQiY&libraries=places"></script>
<script>
  // ... [existing JS variables] ...
  let map;
  let addingMarker = false;
  let questMarkers = [];
  let searchMarker = null;
  let userCurrentPos = null;
  let userMarker = null;
  let directionsService = null;
  let directionsRenderer = null;
  let routeMarkers = [];
  let markerToRemove = null;

  // --- Modal logic for removal ---
  function showRemoveModal(markerObj) {
    markerToRemove = markerObj;
    document.getElementById('removeModalText').innerHTML =
      `Remove quest marker <b>${markerObj.label}</b>?`;
    document.getElementById('removeModal').style.display = 'flex';
  }
  function hideRemoveModal() {
    document.getElementById('removeModal').style.display = 'none';
    markerToRemove = null;
  }
  document.getElementById('removeModalYes').onclick = function() {
    if (markerToRemove) {
      removeQuestMarker(markerToRemove);
      hideRemoveModal();
    }
  };
  document.getElementById('removeModalNo').onclick = hideRemoveModal;

  // --- Marker Persistence Logic ---
  function saveQuestMarkers() {
    localStorage.setItem('questMarkers', JSON.stringify(
      questMarkers.map(markerObj => ({
        position: markerObj.marker.getPosition().toJSON(),
        label: markerObj.label
      }))
    ));
  }

  function loadQuestMarkers() {
    const saved = localStorage.getItem('questMarkers');
    if (!saved) return [];
    try {
      return JSON.parse(saved);
    } catch {
      return [];
    }
  }

  function removeQuestMarker(markerObj) {
    // Remove from map
    markerObj.marker.setMap(null);
    // Remove from array
    questMarkers = questMarkers.filter(obj => obj !== markerObj);
    saveQuestMarkers();
  }

  function addQuestMarker(pos, label, save = true) {
    const marker = new google.maps.Marker({
      position: pos,
      map: map,
      icon: {
        path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
        scale: 5,
        strokeColor: '#00FF00',
        fillColor: '#00FF00',
        fillOpacity: 0.8
      },
      title: label
    });
    const infoWindow = new google.maps.InfoWindow({
      content: `<div style="color:#00ff12;font-family:monospace;">
                  <b>${label}</b>
                </div>`
    });
    marker.addListener('click', () => infoWindow.open(map, marker));

    // Add right-click (contextmenu) to remove
    const markerObj = {marker, label};
    marker.addListener('rightclick', function(e) {
      showRemoveModal(markerObj);
    });

    questMarkers.push(markerObj);
    if (save) saveQuestMarkers();

    // Plot route from user location to marker
    if (userCurrentPos) {
      plotRoute(userCurrentPos, pos);
      setTimeout(() => { map.setCenter(userCurrentPos); }, 1500);
    }
  }

  function restoreQuestMarkers() {
    questMarkers.forEach(obj => obj.marker.setMap(null));
    questMarkers = [];
    const data = loadQuestMarkers();
    data.forEach(({position, label}) => {
      addQuestMarker(position, label, false);
    });
  }

  // ... [keep the rest of your JS unchanged, except as needed for marker removal above] ...
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Map with Background and Navigation</title>
  <style>
    /* ... All your previous styles, unchanged ... */
    /* Modal overlay for marker removal */
    #removeModal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.85);
      align-items: center;
      justify-content: center;
    }
    #removeModal .modal-content {
      background: #101c10;
      border: 2px solid #00FF00;
      border-radius: 10px;
      color: #00FF00;
      font-family: monospace;
      padding: 32px 36px 22px 36px;
      text-align: center;
      box-shadow: 0 0 16px #00ff1c80;
      min-width: 260px;
    }
    #removeModal button {
      background: #0c5116;
      color: #00FF00;
      border: 1.5px solid #00FF00;
      border-radius: 6px;
      font-family: monospace;
      font-size: 1em;
      padding: 5px 18px;
      margin: 0 12px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    #removeModal button:hover {
      background: #00FF00;
      color: #0c5116;
    }
    .selected-marker {
      animation: bounce-selected 0.5s;
    }
    @keyframes bounce-selected {
      0% { transform: translateY(0);}
      30% { transform: translateY(-20px);}
      60% { transform: translateY(0);}
      100% { transform: translateY(0);}
    }
  </style>
</head>
<body>
<!-- ... existing HTML ... -->
<!-- Modal for marker removal -->
<div id="removeModal">
  <div class="modal-content">
    <div id="removeModalText" style="margin-bottom:22px;"></div>
    <button id="removeModalYes">Remove</button>
    <button id="removeModalNo">Cancel</button>
  </div>
</div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDsz_nf-Ithx6y4mVZ3PxUR26WEMaYrQiY&libraries=places"></script>
<script>
  const mapStyle = [/* ... your same mapStyle ... */];

  let map;
  let addingMarker = false;
  let questMarkers = [];
  let searchMarker = null;
  let userCurrentPos = null;
  let userMarker = null;
  let directionsService = null;
  let directionsRenderer = null;
  let routeMarkers = [];
  let markerToRemove = null;

  // --- For route selection ---
  let routeEndpoints = [];

  // --- Modal logic (unchanged) ---
  function showRemoveModal(markerObj) {
    markerToRemove = markerObj;
    document.getElementById('removeModalText').innerHTML =
      `Remove quest marker <b>${markerObj.label}</b>?`;
    document.getElementById('removeModal').style.display = 'flex';
  }
  function hideRemoveModal() {
    document.getElementById('removeModal').style.display = 'none';
    markerToRemove = null;
  }
  document.getElementById('removeModalYes').onclick = function() {
    if (markerToRemove) {
      removeQuestMarker(markerToRemove);
      hideRemoveModal();
    }
  };
  document.getElementById('removeModalNo').onclick = hideRemoveModal;

  // --- Persistence (unchanged) ---
  function saveQuestMarkers() {
    localStorage.setItem('questMarkers', JSON.stringify(
      questMarkers.map(markerObj => ({
        position: markerObj.marker.getPosition().toJSON(),
        label: markerObj.label
      }))
    ));
  }
  function loadQuestMarkers() {
    const saved = localStorage.getItem('questMarkers');
    if (!saved) return [];
    try { return JSON.parse(saved); } catch { return []; }
  }
  function removeQuestMarker(markerObj) {
    markerObj.marker.setMap(null);
    questMarkers = questMarkers.filter(obj => obj !== markerObj);
    saveQuestMarkers();
    // Remove from route endpoints if selected
    routeEndpoints = routeEndpoints.filter(e => e !== markerObj.marker);
    updateRoute();
  }

  // --- Route plotting and selection ---
  function clearRouteMarkers() {
    routeMarkers.forEach(m => m.setMap(null));
    routeMarkers = [];
  }
  function plotRoute(origin, destination) {
    if (!directionsService || !directionsRenderer) return;
    directionsService.route({
      origin: origin,
      destination: destination,
      travelMode: 'DRIVING'
    }, function(response, status) {
      if (status === 'OK') {
        directionsRenderer.setDirections(response);
        clearRouteMarkers();
        const leg = response.routes[0].legs[0];
        // Green A/B markers
        const markerA = new google.maps.Marker({
          position: leg.start_location,
          map: map,
          title: "Start",
          icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
        });
        const markerB = new google.maps.Marker({
          position: leg.end_location,
          map: map,
          title: "Destination",
          icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
        });
        routeMarkers.push(markerA, markerB);
      } else {
        directionsRenderer.set('directions', null);
        clearRouteMarkers();
      }
    });
  }
  function updateRoute() {
    if (routeEndpoints.length === 2) {
      plotRoute(routeEndpoints[0].getPosition(), routeEndpoints[1].getPosition());
    } else {
      directionsRenderer.set('directions', null);
      clearRouteMarkers();
    }
    // Animate selected markers
    questMarkers.forEach(obj => obj.marker.setAnimation(null));
    if (searchMarker) searchMarker.setAnimation(null);
    routeEndpoints.forEach(m => {
      m.setAnimation(google.maps.Animation.BOUNCE);
      setTimeout(() => m.setAnimation(null), 500);
    });
  }
  function toggleRouteMarker(marker) {
    const idx = routeEndpoints.indexOf(marker);
    if (idx !== -1) {
      routeEndpoints.splice(idx, 1);
    } else if (routeEndpoints.length < 2) {
      routeEndpoints.push(marker);
    } else {
      // Swap if already 2
      routeEndpoints = [routeEndpoints[1], marker];
    }
    updateRoute();
  }

  // --- Quest marker creation with route selection and removal ---
  function addQuestMarker(pos, label, save = true) {
    const marker = new google.maps.Marker({
      position: pos,
      map: map,
      icon: {
        path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
        scale: 5,
        strokeColor: '#00FF00',
        fillColor: '#00FF00',
        fillOpacity: 0.8
      },
      title: label
    });
    const infoWindow = new google.maps.InfoWindow({
      content: `<div style="color:#00ff12;font-family:monospace;">
                  <b>${label}</b>
                </div>`
    });
    marker.addListener('click', () => {
      infoWindow.open(map, marker);
      toggleRouteMarker(marker);
    });

    // Remove marker logic: right-click or long-press
    const markerObj = {marker, label};
    marker.addListener('rightclick', function(e) {
      showRemoveModal(markerObj);
    });
    let longPressTimeout = null;
    marker.addListener('mousedown', function(e) {
      if ('ontouchstart' in window) {
        longPressTimeout = setTimeout(() => {
          showRemoveModal(markerObj);
        }, 700);
      }
    });
    marker.addListener('mouseup', function(e) {
      if (longPressTimeout) clearTimeout(longPressTimeout);
    });
    marker.addListener('touchstart', function(e) {
      longPressTimeout = setTimeout(() => {
        showRemoveModal(markerObj);
      }, 700);
    });
    marker.addListener('touchend', function(e) {
      if (longPressTimeout) clearTimeout(longPressTimeout);
    });

    questMarkers.push(markerObj);
    if (save) saveQuestMarkers();
  }
  function restoreQuestMarkers() {
    questMarkers.forEach(obj => obj.marker.setMap(null));
    questMarkers = [];
    const data = loadQuestMarkers();
    data.forEach(({position, label}) => {
      addQuestMarker(position, label, false);
    });
  }

  // --- Search/Autocomplete with route selection ---
  function initAutocomplete() {
    const input = document.getElementById('pac-input');
    const autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo("bounds", map);

    autocomplete.addListener("place_changed", function () {
      const place = autocomplete.getPlace();
      if (!place.geometry) {
        alert("No details available for input: '" + place.name + "'");
        return;
      }
      if (searchMarker) searchMarker.setMap(null);

      searchMarker = new google.maps.Marker({
        map: map,
        position: place.geometry.location,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 7,
          fillColor: '#00FF00',
          fillOpacity: 0.9,
          strokeColor: '#00FF00',
          strokeWeight: 2
        },
        title: place.name
      });
      map.setCenter(place.geometry.location);
      map.setZoom(15);

      const infoWindow = new google.maps.InfoWindow({
        content: `<div style="color:#00ff12;font-family:monospace;"><b>${place.name}</b></div>`
      });
      searchMarker.addListener('click', () => {
        infoWindow.open(map, searchMarker);
        toggleRouteMarker(searchMarker);
      });
      infoWindow.open(map, searchMarker);
    });
  }

  // --- Main Map Init ---
  function initMap() {
    const defaultCenter = { lat: 40.7128, lng: -74.0060 };
    map = new google.maps.Map(document.getElementById('map'), {
      center: defaultCenter,
      zoom: 12,
      styles: mapStyle,
      mapTypeControl: false,
      mapTypeId: 'roadmap'
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: true,
      polylineOptions: {
        strokeColor: "#00FF00",
        strokeWeight: 6,
        strokeOpacity: 0.7
      }
    });
    directionsRenderer.setMap(map);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        position => {
          const userPos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          userCurrentPos = userPos;
          map.setCenter(userPos);
          userMarker = new google.maps.Marker({
            position: userPos,
            map,
            title: "You are here!",
            icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
          });
        }
      );
    }
    restoreQuestMarkers();

    map.addListener('click', function(event) {
      if (addingMarker) {
        const label = prompt("Name this quest location:");
        if (label && label.trim().length > 0) {
          addQuestMarker(event.latLng, label.trim());
        }
        addingMarker = false;
        map.setOptions({draggableCursor: null});
      }
    });
    initAutocomplete();
  }

  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('addQuestBtn').addEventListener('click', function() {
      addingMarker = true;
      map.setOptions({draggableCursor: 'crosshair'});
    });
  });

  // --- Navigation logic with top 20% restriction ---
  // ... [All your navigation code, unchanged] ...

  window.onload = function() {
    initMap();
    clickableAreas[currentIndex].classList.add('highlight');
  }
</script>
</body>
</html>

<!-- ... (your head and body up to the script tag remain unchanged) ... -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDsz_nf-Ithx6y4mVZ3PxUR26WEMaYrQiY&libraries=places"></script>
<script>
  // ... (all your previous JS code remains unchanged up to here) ...

  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('addQuestBtn').addEventListener('click', function() {
      addingMarker = true;
      map.setOptions({draggableCursor: 'crosshair'});
    });

    // --- Direct tap/click on navigation opens link instantly after sound ---
    document.querySelectorAll('.clickable-area a').forEach(link => {
      // Remove any previous click handler
      link.onclick = null;
      // Click (mouse or finger tap)
      link.addEventListener('click', function(event) {
        event.preventDefault();
        var audio = document.getElementById('clickSound');
        audio.currentTime = 0;
        audio.play();
        setTimeout(() => {
          window.location.href = link.href;
        }, 200);
      }, { passive: false });
      // Touchstart for instant mobile response
      link.addEventListener('touchstart', function(event) {
        event.preventDefault();
        var audio = document.getElementById('clickSound');
        audio.currentTime = 0;
        audio.play();
        setTimeout(() => {
          window.location.href = link.href;
        }, 200);
      }, { passive: false });
    });
  });

  // --- Navigation logic with top 20% restriction ---
  // (Your existing highlight/swipe/keyboard nav code remains unchanged below)

  const clickableAreas = [
    document.querySelector('a[href="stats.html"]'),
    document.querySelector('a[href="inv.html"]'),
    document.querySelector('a[href="index.html"]'),
    document.querySelector('a[href="map.html"]'),
    document.querySelector('a[href="radio.html"]'),
  ];
  let currentIndex = 0;
  let debounceTimeout = null;
  const DEBOUNCE_DELAY = 300;
  function debounceAction(callback) {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(callback, DEBOUNCE_DELAY);
  }
  function playSound(event) {
    event.preventDefault();
    var audio = document.getElementById('clickSound');
    audio.play();
    setTimeout(function() {
      window.location.href = event.target.href;
    }, 500);
  }
  function highlightNextArea() {
    debounceAction(() => {
      clickableAreas[currentIndex].classList.remove('highlight');
      currentIndex = (currentIndex + 1) % clickableAreas.length;
      clickableAreas[currentIndex].classList.add('highlight');
      var audio = document.getElementById('clickSound');
      audio.play();
    });
  }
  function highlightPreviousArea() {
    debounceAction(() => {
      clickableAreas[currentIndex].classList.remove('highlight');
      currentIndex = (currentIndex - 1 + clickableAreas.length) % clickableAreas.length;
      clickableAreas[currentIndex].classList.add('highlight');
      var audio = document.getElementById('clickSound');
      audio.play();
    });
  }
  function activateSelectedArea() {
    const currentLink = clickableAreas[currentIndex];
    currentLink.click();
  }
  let touchStartY = 0;
  let lastSwipeTime = 0;
  const DOUBLE_SWIPE_THRESHOLD = 500;
  let isTouchingMap = false;
  document.getElementById('mapContainer').addEventListener('touchstart', function(e) {
    isTouchingMap = true;
  }, { passive: true });
  document.getElementById('mapContainer').addEventListener('touchend', function(e) {
    isTouchingMap = false;
  }, { passive: true });

  function isInTop20Percent(y) {
    return y < window.innerHeight * 0.2;
  }

  document.addEventListener('touchstart', function(e) {
    if (e.target.closest('#mapContainer')) {
      return;
    }
    const y = e.touches[0].clientY;
    if (!isInTop20Percent(y)) return;
    touchStartY = y;
  }, { passive: true });

  document.addEventListener('touchmove', function(e) {
    if (isTouchingMap || e.target.closest('#mapContainer')) {
      return;
    }
    const y = e.touches[0].clientY;
    if (!isInTop20Percent(y)) return;
    const touchEndY = y;
    const screenHeight = window.innerHeight;
    if (touchStartY > touchEndY && touchEndY < screenHeight / 2) {
      highlightNextArea();
    } else if (touchStartY < touchEndY && touchEndY > screenHeight / 2) {
      const currentTime = Date.now();
      if (currentTime - lastSwipeTime < DOUBLE_SWIPE_THRESHOLD) {
        highlightPreviousArea();
      } else {
        highlightPreviousArea();
      }
      lastSwipeTime = currentTime;
    }
  }, { passive: false });

  window.addEventListener('wheel', function(event) {
    if (event.target.closest('#mapContainer')) return;
    event.preventDefault();
    if (event.clientY !== undefined && !isInTop20Percent(event.clientY)) return;
    if (event.deltaY > 0) {
      highlightNextArea();
    } else {
      highlightPreviousArea();
    }
  }, { passive: false });

  document.addEventListener('keydown', function(event) {
    if (event.key === 'ArrowDown' || event.key === 'ArrowRight') {
      highlightNextArea();
    }
    else if (event.key === 'ArrowUp' || event.key === 'ArrowLeft') {
      highlightPreviousArea();
    }
    else if (event.key === 'Enter') {
      activateSelectedArea();
    }
  });

  let lastTapTime = 0;
  const DOUBLE_TAP_THRESHOLD = 500;
  document.addEventListener('touchstart', function(e) {
    if (e.target.closest('#mapContainer')) {
      return;
    }
    const y = e.touches[0].clientY;
    if (!isInTop20Percent(y)) return;
    e.preventDefault();
    const currentTime = new Date().getTime();
    const timeDifference = currentTime - lastTapTime;
    if (timeDifference < DOUBLE_TAP_THRESHOLD) {
      activateSelectedArea();
    } else {
      highlightNextArea();
    }
    lastTapTime = currentTime;
  }, { passive: false });

  window.onload = function() {
    initMap();
    clickableAreas[currentIndex].classList.add('highlight');
  }
</script>
</body>
</html>
